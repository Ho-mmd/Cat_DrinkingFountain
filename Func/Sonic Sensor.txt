#include <avr/io.h>

#include <avr/delay.h>

#include <avr/interrupt.h>



volatile unsigned int start=0,end=0,dist=0;

volatile unsigned char a[10] = {0x81, 0xB7, 0xC2, 0x92, 0xB4, 0x98, 0x88, 0xB1, 0x80, 0x90};



int main(){

	cli();

	DDRB = 0xFF; // 7seg
	DDRF = 0xFF; // Trig
	DDRD = 0x00; // Ehco
	EICRA = (0<<ISC31) | (0<<ISC30) | (0<<ISC21) | (0<<ISC20) | (1<<ISC11) | (0<<ISC11) | (0<<ISC01) | (0<<ISC00);
	// 초기값 = 라이징엣지

	EIMSK = (0<<INT7) | (0<<INT6) | (0<<INT5) | (0<<INT4) | (0<<INT3) | (0<<INT2) | (1<<INT1) | (0<<INT0);

	TIMSK = 0x04;
	TCCR1A = 0X00;
	TCCR1B = 0X05;

	TCNT1H = 0xFF;
	TCNT1L = 0xFE;

	sei();

	do{


	}while(1);



}


ISR(INT1_vect){ //ehco
   	cli();

	if(EICRA == 0x0C){    // 라이징엣지에서 인터럽트가 걸리면
        start=TCNT1; // TCNT1값을 저장해두고
        EICRA=0x08;     // 다음번 인터럽트는 폴링엣지로 설정
    }

	else{            // 폴링엣지에서 인터럽트가 걸리면
        end=TCNT1;   // TCNT1값을 저장해두고
        EICRA=0x0C;     // 다음번 인터럽트는 라이징엣지로 설정
        dist= (int)( (float)(end-start) / 14.5 ); // 58us / 4us = 14.5, cm로 변환

		if(dist == 0) // dist 값을 7seg에 표시(수정해서 범위 지정가능)
			PORTB = a[0];
		else if(dist == 1)
			PORTB = a[1];
		else if(dist == 2)
			PORTB = a[2];
		else if(dist == 3)
			PORTB = a[3];
		else if(dist == 4)
			PORTB = a[4];
		else if(dist == 5)
			PORTB = a[5];
		else if(dist == 6)
			PORTB = a[6];
		else if(dist == 7)
			PORTB = a[7];
		else if(dist == 8)
			PORTB = a[8];
		else if(dist == 9)
			PORTB = a[9];

    }
	PORTB = 0x10;
	_delay_ms(2);
	PORTB = 0x00;
	_delay_ms(18);

   sei();
}



ISR(TIMER1_OVF_vect){ // 일정시간마다 초음파센서 Trig 발생
   	cli();

   	TCNT1H = 0xE1;
   	TCNT1L = 0x7A;

   	PORTF = 0xFF;
	_delay_us(10);

	PORTF = 0x00;

   	sei();



}
